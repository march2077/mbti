<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ NaNa Luxury Christmas Tree</title>
    
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if(msg.includes('ResizeObserver')) return;
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed; top:0; left:0; z-index:9999; background:rgba(0,0,0,0.8); color:#ff5555; padding:20px; font-family:monospace;';
            div.innerHTML = `âš ï¸ Error: ${msg}<br/>Line: ${line}`;
            document.body.appendChild(div);
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital@1&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0');

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #020202; overflow: hidden; }
        
        /* å¼·åˆ¶ React æ ¹å®¹å™¨å¡«æ»¿è¦–çª— */
        #root {
            width: 100vw; height: 100vh;
            position: fixed; top: 0; left: 0;
            overflow: hidden;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* æ¨™é¡Œ */
        header {
            text-align: center; margin-top: 3vh;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            pointer-events: none;
        }
        h1 {
            font-family: 'Cinzel', serif; 
            color: #d4af37; 
            font-size: 2.5rem; /* ç¨å¾®åŠ å¤§ä¸€é»æ¨™é¡Œ */
            margin: 0; 
            letter-spacing: 0.1em;
            background: linear-gradient(to bottom, #ffd700, #b8860b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        p.subtitle {
            font-family: 'Playfair Display', serif; color: #a4c6a4; 
            font-size: 1rem; 
            margin-top: 5px; font-style: italic; opacity: 0.8;
        }

        .controls {
            pointer-events: auto;
            display: flex; justify-content: center; gap: 20px;
            margin-bottom: 6vh; 
        }

        .btn-luxury {
            background: linear-gradient(135deg, #d4af37 0%, #f9f295 50%, #aa8e28 100%);
            border: 1px solid #fff8e7;
            padding: 10px 30px; 
            min-width: 150px;  
            font-size: 1rem; 
            font-family: 'Cinzel', serif; font-weight: bold; color: #2a1a00;
            cursor: pointer; border-radius: 30px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-luxury:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            background: linear-gradient(135deg, #fff 0%, #ffd700 100%);
        }
        .btn-luxury:active { transform: translateY(0); }

        .material-symbols-rounded { font-size: 1.2rem; }

        .loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #d4af37; font-family: 'Cinzel', serif; font-size: 1.2rem;
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "three": "https://esm.sh/three@0.160.0",
            "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.12?external=react,react-dom,three",
            "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
            "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
            "postprocessing": "https://esm.sh/postprocessing@6.34.1?external=three"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useMemo, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { OrbitControls, PerspectiveCamera, Float, Sparkles, Image as DreiImage, Environment, Html, useProgress } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette } from '@react-three/postprocessing';

        // --- è¨­å®šèˆ‡è³‡æ–™ ---
        const PHOTO_PATHS = [
            "images/INTJ_boy.jpg", "images/INTJ_girl.jpg", "images/INTP_boy.jpg", "images/INTP_girl.jpg",
            "images/ENTJ_boy.jpg", "images/ENTJ_girl.jpg", "images/ENTP_boy.jpg", "images/ENTP_girl.jpg",
            "images/INFJ_boy.jpg", "images/INFJ_girl.jpg", "images/INFP_boy.jpg", "images/INFP_girl.jpg",
            "images/ENFJ_boy.jpg", "images/ENFJ_girl.jpg", "images/ENFP_boy.jpg", "images/ENFP_girl.jpg",
            "images/ISTJ_boy.jpg", "images/ISTJ_girl.jpg", "images/ISFJ_boy.jpg", "images/ISFJ_girl.jpg",
            "images/ESTJ_boy.jpg", "images/ESTJ_girl.jpg", "images/ESFJ_boy.jpg", "images/ESFJ_girl.jpg",
            "images/ISTP_boy.jpg", "images/ISTP_girl.jpg", "images/ISFP_boy.jpg", "images/ISFP_girl.jpg",
            "images/ESTP_boy.jpg", "images/ESTP_girl.jpg", "images/ESFP_boy.jpg", "images/ESFP_girl.jpg"
        ];

        const COLORS = { EMERALD: "#046307", GOLD: "#FFD700", RED: "#8B0000", SILVER: "#C0C0C0" };

        // --- æ ¸å¿ƒæ¼”ç®—æ³• ---
        const randomVector = (r) => {
            const theta = 2 * Math.PI * Math.random();
            const phi = Math.acos(2 * Math.random() - 1);
            return new THREE.Vector3(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
        };

        const treeVector = (i, count, radiusBase, height) => {
            const y = (i / count) * height; 
            const radius = radiusBase * (1 - Math.pow(y / height, 0.8));
            const angle = i * 2.4;
            return new THREE.Vector3(Math.cos(angle) * radius, y, Math.sin(angle) * radius);
        };

        // --- 3D å…ƒä»¶ ---
        function TreeParticles({ isFormed }) {
            const leafCount = 2500;
            const decorCount = 300;
            const leavesRef = useRef();
            const decorRef = useRef();
            const dummy = useMemo(() => new THREE.Object3D(), []);

            const leafData = useMemo(() => new Array(leafCount).fill(0).map((_, i) => ({
                treePos: treeVector(i, leafCount, 12, 26), 
                chaosPos: randomVector(20),
                current: randomVector(20),
                scale: Math.random() * 0.25 + 0.1,
                speed: Math.random() * 0.02 + 0.04
            })), []);

            const decorData = useMemo(() => new Array(decorCount).fill(0).map((_, i) => {
                const colorKeys = Object.keys(COLORS).filter(k => k !== 'EMERALD');
                const randColor = COLORS[colorKeys[Math.floor(Math.random() * colorKeys.length)]];
                const vec = treeVector(i, decorCount, 12.5, 25);
                vec.x += (Math.random()-0.5); vec.z += (Math.random()-0.5);
                return {
                    treePos: vec,
                    chaosPos: randomVector(25),
                    current: randomVector(25),
                    scale: Math.random() * 0.4 + 0.3,
                    color: new THREE.Color(randColor),
                    speed: Math.random() * 0.02 + 0.03
                };
            }), []);

            useFrame((state) => {
                const t = state.clock.elapsedTime;
                if(leavesRef.current) {
                    leafData.forEach((d, i) => {
                        const target = isFormed ? d.treePos : d.chaosPos;
                        d.current.lerp(target, d.speed);
                        dummy.position.copy(d.current);
                        if(isFormed) dummy.position.y += Math.sin(t + i*0.1) * 0.02;
                        else dummy.rotation.x += 0.01;
                        dummy.scale.setScalar(d.scale);
                        dummy.updateMatrix();
                        leavesRef.current.setMatrixAt(i, dummy.matrix);
                    });
                    leavesRef.current.instanceMatrix.needsUpdate = true;
                }
                if(decorRef.current) {
                    decorData.forEach((d, i) => {
                        const target = isFormed ? d.treePos : d.chaosPos;
                        d.current.lerp(target, d.speed * 0.8);
                        dummy.position.copy(d.current);
                        if(isFormed) dummy.position.y += Math.cos(t + i*0.2) * 0.03;
                        else { dummy.rotation.y += 0.02; dummy.rotation.z += 0.01; }
                        dummy.scale.setScalar(d.scale);
                        dummy.updateMatrix();
                        decorRef.current.setMatrixAt(i, dummy.matrix);
                        decorRef.current.setColorAt(i, d.color);
                    });
                    decorRef.current.instanceMatrix.needsUpdate = true;
                    if(decorRef.current.instanceColor) decorRef.current.instanceColor.needsUpdate = true;
                }
            });

            return (
                <group>
                    <instancedMesh ref={leavesRef} args={[null, null, leafCount]}>
                        <sphereGeometry args={[1, 6, 6]} />
                        <meshStandardMaterial color={COLORS.EMERALD} roughness={0.8} />
                    </instancedMesh>
                    <instancedMesh ref={decorRef} args={[null, null, decorCount]}>
                        <sphereGeometry args={[1, 16, 16]} />
                        <meshStandardMaterial roughness={0.1} metalness={0.8} />
                    </instancedMesh>
                </group>
            );
        }

        function Polaroid({ url, index, isFormed, isUnleashed, setZoom, zoomedId }) {
            const group = useRef();
            const [hovered, setHover] = useState(false);
            
            const { treePos, chaosPos, randomRot } = useMemo(() => {
                const t = treeVector(index, 32, 13, 24); 
                t.y += 1; 
                return {
                    treePos: t,
                    chaosPos: randomVector(30),
                    randomRot: [Math.random()*Math.PI, Math.random()*Math.PI, 0]
                };
            }, [index]);

            useFrame((state) => {
                if(!group.current) return;
                const isZoomed = zoomedId === index;
                
                let targetPos = new THREE.Vector3();
                let targetRot = new THREE.Quaternion();
                let targetScale = 1;

                if (isZoomed) {
                    const cam = state.camera;
                    // å°‡ç…§ç‰‡ç§»å‹•åˆ°ç›¸æ©Ÿå‰æ–¹ä¸é è™•
                    const fwd = new THREE.Vector3(0, 0, -5).applyQuaternion(cam.quaternion);
                    targetPos.copy(cam.position).add(fwd);
                    targetRot.copy(cam.quaternion);
                    targetScale = 3.0; 
                } else {
                    targetPos = isFormed ? treePos : chaosPos;
                    if (isFormed) {
                        const dummy = new THREE.Object3D();
                        dummy.position.copy(targetPos);
                        dummy.lookAt(0, targetPos.y, 0); 
                        targetRot.setFromEuler(dummy.rotation);
                    } else {
                        const dummy = new THREE.Object3D();
                        dummy.rotation.set(...randomRot);
                        dummy.rotation.x += state.clock.elapsedTime * 0.1;
                        targetRot.setFromEuler(dummy.rotation);
                        targetPos.y += Math.sin(state.clock.elapsedTime + index) * 0.05;
                    }
                    targetScale = (hovered && isUnleashed && !zoomedId) ? 1.5 : 1;
                }

                group.current.position.lerp(targetPos, 0.08);
                group.current.quaternion.slerp(targetRot, 0.1);
                group.current.scale.lerp(new THREE.Vector3(targetScale, targetScale, targetScale), 0.1);
            });

            return (
                <group ref={group}
                    onClick={(e) => { e.stopPropagation(); if(isUnleashed) setZoom(zoomedId === index ? null : index); }}
                    onPointerOver={() => isUnleashed && setHover(true)}
                    onPointerOut={() => setHover(false)}
                >
                    {/* ç™½æ¡† */}
                    <mesh position={[0,0,-0.02]}>
                        <boxGeometry args={[1.2, 1.5, 0.05]} />
                        <meshStandardMaterial color="#f8f8f8" roughness={0.5} />
                    </mesh>
                    
                    {/* ç…§ç‰‡ï¼štoneMapped={false} ç¢ºä¿ç…§ç‰‡ä¸è¢«ç’°å¢ƒå…‰å’Œå¾ŒæœŸç‰¹æ•ˆè®Šæš—ï¼Œé‚„åŸåŸæœ¬è‰²å½© */}
                    <Suspense fallback={<mesh><planeGeometry /><meshBasicMaterial color="#333"/></mesh>}>
                        <DreiImage 
                            url={url} 
                            position={[0, 0.15, 0.02]} 
                            scale={[1, 1, 1]} 
                            transparent 
                            toneMapped={false} 
                        />
                    </Suspense>
                    
                    {/* åº•éƒ¨ç°½åå€ */}
                    <mesh position={[0,-0.6,0.02]}>
                        <planeGeometry args={[0.9, 0.2]} />
                        <meshBasicMaterial color="#f8f8f8" />
                    </mesh>
                </group>
            );
        }

        // --- å ´æ™¯çµ„ä»¶ ---
        function Scene({ isFormed, setZoom, zoomedId }) {
            // --- ğŸ”’ é–å®šåƒæ•¸ ğŸ”’ ---
            // Camera Z = 73
            // Target Y = 10
            // Tree Y = 0 (ä¸éœ€è¦ä½ç§»)
            
            return (
                <>
                    <PerspectiveCamera 
                        makeDefault 
                        position={[0, 0, 73]} 
                        fov={60} 
                        near={0.1} 
                        far={500} 
                    />
                    
                    <OrbitControls 
                        enablePan={false} 
                        minDistance={20} 
                        maxDistance={150} 
                        target={[0, 10, 0]} 
                        autoRotate={isFormed && !zoomedId} 
                        autoRotateSpeed={0.8} 
                    />

                    <ambientLight intensity={0.4} color="#fff0d0" />
                    
                    {/* åŸæœ‰ç‡ˆå…‰ï¼Œç…§äº®æ¨¹é«” */}
                    <pointLight position={[10, 20, 10]} intensity={2} color="#FFD700" />
                    <pointLight position={[-10, 5, 10]} intensity={1} color="#ff4400" />
                    
                    {/* ğŸ”¦ è£œå…‰ç‡ˆï¼šæ”¾åœ¨ç›¸æ©Ÿé™„è¿‘ (Z=70)ï¼Œç¢ºä¿è¢«æŠ½å–çš„ç…§ç‰‡æ­£é¢æ˜¯äº®çš„ */}
                    <pointLight position={[0, 10, 70]} intensity={1.0} color="#ffffff" distance={50} decay={2} />

                    <Environment preset="lobby" />

                    {/* Tree Y è¨­ç‚º 0 */}
                    <group position={[0, 0, 0]}> 
                        <TreeParticles isFormed={isFormed} />
                        <Float speed={1} rotationIntensity={1} floatIntensity={1}>
                            <Sparkles count={150} scale={25} size={5} speed={0.4} opacity={0.6} color="#FFD700" />
                        </Float>
                        {PHOTO_PATHS.map((path, i) => (
                            <Polaroid 
                                key={i} 
                                index={i} 
                                url={path} 
                                isFormed={isFormed} 
                                isUnleashed={!isFormed}
                                setZoom={setZoom}
                                zoomedId={zoomedId}
                            />
                        ))}
                    </group>

                    <EffectComposer disableNormalPass>
                        <Bloom luminanceThreshold={0.7} mipmapBlur intensity={1.8} radius={0.6} />
                        <Vignette eskil={false} offset={0.1} darkness={0.8} />
                    </EffectComposer>
                </>
            );
        }

        function Loader() {
            const { progress } = useProgress();
            return <Html center><div className="loader">{progress.toFixed(0)}%</div></Html>;
        }

        function App() {
            const [mode, setMode] = useState('FORMED');
            const [zoomedId, setZoomedId] = useState(null);

            const handleToggle = () => {
                setMode(prev => prev === 'FORMED' ? 'CHAOS' : 'FORMED');
                setZoomedId(null);
            };

            const handleRandom = () => {
                const randomId = Math.floor(Math.random() * PHOTO_PATHS.length);
                setZoomedId(randomId);
            };
            
            return (
                <>
                    <div id="ui-layer">
                        <header>
                            <h1><span style={{fontSize:'2.5rem', verticalAlign:'middle'}}>ğŸ¾</span> NANA'S CHRISTMAS</h1>
                            <p className="subtitle">Grand Luxury Interactive Edition</p>
                        </header>
                        
                        <div className="controls">
                            <button className="btn-luxury" onClick={handleToggle}>
                                <span className="material-symbols-rounded">
                                    {mode === 'FORMED' ? 'filter_drama' : 'park'}
                                </span>
                                {mode === 'FORMED' ? "Unleash" : "Form Tree"}
                            </button>

                            <button className="btn-luxury" onClick={handleRandom}>
                                <span className="material-symbols-rounded">shuffle</span>
                                Lucky Pick
                            </button>
                        </div>
                        
                        <div style={{position:'absolute', bottom:'10px', right:'20px', color:'#d4af37', opacity:0.6, fontSize:'0.8rem'}}>
                            {mode === 'FORMED' ? "Drag to Rotate" : "Click Photos to Zoom"}
                        </div>
                    </div>

                    <Canvas gl={{ antialias: false, toneMapping: THREE.ReinhardToneMapping, toneMappingExposure: 1.5 }} dpr={[1, 1.5]}>
                        <color attach="background" args={['#020202']} />
                        <Suspense fallback={<Loader />}>
                            <Scene 
                                isFormed={mode === 'FORMED'} 
                                setZoom={setZoomedId} 
                                zoomedId={zoomedId}
                            />
                        </Suspense>
                    </Canvas>
                    
                    {zoomedId !== null && (
                        <div 
                            style={{position:'fixed', top:0, left:0, width:'100%', height:'100%', background:'rgba(0,0,0,0.8)', zIndex:5, cursor:'pointer'}}
                            onClick={() => setZoomedId(null)}
                        ></div>
                    )}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
